@page "/work"
@inject IArticleStore _articleStore;

<h2 class="white-text text-center mb-5 vp-anim-3">Work Showcase</h2>

@if (CanDrawCards())
{
    <div class="dropdown mb-5 text-center">
        <button class="btn dropdown-toggle main-button vp-anim-4" type="button"
                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            Tags
        </button>
        <div class="dropdown-menu dropdown-menu-center constant-glow px-0 py-0">
            <form class="text-left px-2 py-1 white-text">
                @foreach (var tag in availableTags)
                {
                    <div class="py-1 simple-hover" @onclick="() => tag.IsSelected = !tag.IsSelected">
                        <a class="non-selectable">
                            <span class="@(tag.IsSelected ? "far fa-check-square" : "far fa-square") main-color"></span>
                            @(tag.Name)
                        </a>
                    </div>
                }
            </form>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            @foreach (var articleMetadata in workArticlesMetadata)
            {
                bool isCardTagSelected = availableTags.Where(x => x.IsSelected).Select(x => x.Name).Intersect(articleMetadata.Tags).Any();

                <div class="col-md-6 mb-5 vp-anim-4" style="@(isCardTagSelected ? "display: block" : "display: none")">
                    <WorkItemCard Id="@articleMetadata.Id"
                                  Title="@articleMetadata.Title"
                                  ImagePath="@articleMetadata.ImagePath"
                                  Description="@articleMetadata.Description"
                                  pageRef="@articleMetadata.PageRef"
                                  publishDate="@articleMetadata.PublishDate"
                                  Tags="@articleMetadata.Tags"></WorkItemCard>
                </div>
            }
        </div>
    </div>
}
else
{
    <div class="empty-block"></div>
    <Loader @ref="loader" TimeOut="8000" TimeOutMessage="Unable to get the article data. Please try again."></Loader>
}

@code {

    private Loader loader;

    private List<ArticleMetadataModel> workArticlesMetadata = [];
    private List<ArticleTagModel> availableTags = [];

    protected async override Task OnInitializedAsync()
    {
        this.workArticlesMetadata = (await this._articleStore.GetArticleMetadataAsync()).ToList();
        this.availableTags = (await this._articleStore.GetAvailableTagsAsync()).ToList();
    }

	// TODO: improve this logic
    private bool CanDrawCards()
    {
        bool canDrawCards = workArticlesMetadata.Count > 0 && !loader.HasTimedOut;

        if (canDrawCards)
        {
            loader.StopTimeOut();
        }

        return canDrawCards;
    }
}
